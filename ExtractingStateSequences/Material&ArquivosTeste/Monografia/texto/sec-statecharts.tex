%% ------------------------------------------------------------------------- %%
\section{Statecharts and Automata}
\label{sec:statecharts}

A software specification is a reference document which contains the requisites the program should satisfy. It can also be understood as a model of how the system should behave. A specification may be developed with natural language, with user cases for example, or usisng formal software engeering techniques.

Statechats are a type of formal software specification based on finite states machines (FSM) specially used in complex systems modeling, such as reactive systems and were defined in \cite{harel87:semantics_statecharts}. Similar to an automaton, a statechart has sets of states, transitions and input events that cause change of state. However, a statechart has additional features: orthogonality, hierarchy, broadcasting, guard conditions and history.

\subsection{Nondeterministic finite automata}

\textbf{Definition\cite{Lewis:98}:} A nondeterministic finite automaton is a quintuple $M = (K,\Sigma,\Delta,s,F)$, where:

\begin{itemize}

\item $K$ is the set of states

\item $\Sigma$ is the input alphabet

\item $\Delta$ is the transition relation, a subset of $K\times(\Sigma\cup{e})\times K$, where $e$ is the empty string

\item $s \in K$ is the initial state

\item $F \subseteq K$ is the set of final states
\end{itemize}

Each triple $(q,a,p) \in \Delta$ is a transition of $M$. If $M$ is currently in state $q$ and the next input is $a$, then $M$ may follow any transition of the form $(q,a,p)$ or $(q,e,p)$. In the later case, no input is read. A configuration of $M$ is an element of $K\time \Sigma^*$ and the relation $\vdash$ (yields one step) between two configuarions is defined as: $(q,w) \vdash (q',w') \Leftrightarrow$ there is a $u \in \Sigma \cup {e}$ such that $w = uw'$ and $(q,u,q') \in \Delta$.

Further information and formalisms regarding finite automata can be obtained in \cite{Lewis:98}. 

\subsubsection{A nondeterministic finite automaton example}

Find below an example of a nondeterministic finite automaton extracted from \cite{Lewis:98}.

\begin{itemize}
\item $K = \{q_0, q_1, q_2\}$

\item $\Sigma = \{a, b\}$

\item $\Delta = \{(q_0,a,q_1),(q_1,b,q_2),(q_2,a,q_0),(q_2,e,q_0)\}$

\item $s = q_0$

\item $F = \{q_0\}$ is the set of final states
\end{itemize}

\begin{figure}[htb]
\centering
\includegraphics[width=2in]{figuras/nfa1}
\caption{\label{fig:nfa1}A nondeterministic finite automaton that accpets language $L = (ab \cup aba)^{*}$.}
\end{figure}



\subsection{Statechart models}

A statechart model can be considered an extended finite state machine. The syntax of statechart is defined over the set of states, transitions, events, actions, conditions, expressions and labels \cite{harel87:semantics_statecharts}. In short terms:

\begin{itemize}

\item Transitions are the relations between states

\item Events are the input that might cause a transition to happen

\item Actions are generally triggered when a transition occurs

\item Conditions are boolean verifications added to a transition in order to restrict the occurrence of that transitions

\item Expressions are composed by variables and algebraic operations over them

\item A label is a pair made of an event and an action that is used to name a transition
\end{itemize}

Furthermore, it is worth noting that a statechart model possesses other features, described over the next sections of this chapter, that do not appear in a common finite state machine. These extra resources are useful, for instance, to model concurrency and different abstraction levels in a more practical way.

\begin{figure}[htb]
\includegraphics[width=1.0\textwidth]{figuras/statechartExample1}
\caption{\label{fig:stateClock}Statechart example. A clock model.}
\end{figure}

\subsubsection{Orthogonality}

More than one state may be active at the same time in a statechart, such behaviour is called orthogonality. It can be used to model concurrent and parallel situations. The set of active states in a certain moment is called configuration. In figure~\ref{fig:stateClock}, we have parallel regions inside the state $Clock$: $r1$ and $r2$. At the same moment, then, states $Display$ and $AlarmOff$ can be active.

\subsubsection{Hierarchy}

It is possible that a state contains other states, called substates, and internal transitions, increasing the abstraction and encapsulation level of the model. In figure~\ref{fig:stateClock}, we have that $Display, Settings, AlarmOff, AlarmOn$ and $AlarmRinging$ are substates of $Clock$. $Display$ also contains the substates: $DisplayHour, DisplayMinutes$ and $hist$. And the states $SetHour, SetMinutes$ and $ActivateAlarm$ are inside state $Settings$. 

\subsubsection{Guard conditions}

In a transition, a guard condition is always verified before the change of states take place. If the condition is satisfied, in other words, if the expression returns true, the transition will happen. Otherwise, that transition is not allowed to happen. A expression in a guard condition involve variables and operations. In figure~\ref{fig:stateClock}, the transition from $AlarmOff$ to $AlarmOn$ is guarded by the condition $[alarm]$, meaning that the trasition will only happen if the value of the variable $alarm$ is $true$.

\subsubsection{Broadcasting}

A transition might have a action that is triggered once the transition is performed.  An action may cause another transitions to happen, which is called broadcasting. This feature makes it possible that chain reactions occurr in a statechart model. Consider figure~\ref{fig:stateClock}, if we are currently in states $ActivateAlarm$ and $AlarmOff$ and the $mode$ event occurs, we will have the following situation: the transition will be execute and we will stay at state $ActivateAlarm$, the value of variable $alarm$ will be changed to its opposite (let's supposed it was $false$, so now it will be $true$) and we will also go to state $AlarmOn$ since the condition $[alarm]$ guarding the transition between these last two state is satisfied. Therefore, not only the transition starting at $ActivateAlarm$ happened when $mode$ occured, but also the transition between $AlarmOff$ and $AlarmOn$. The change of the value of variable $alsarm$ was broadcasted to the whole statechart and a chain reaction happened.

\subsubsection{History}

A statechart is capable of remembering previously visited states by accessing the history state. Consider figure~\ref{fig:stateClock}, suppose we are in state $DisplayMinutes$ and event $set$ happened three times in a row. So, we went to $SetHour$, and then $SetMinutes$ and now we are at $ActivateAlarm$. If there is another occurrence of $set$, we will be directed to the history state $hist$. Since the last active substate in $Display$ was $DisplayMinutes$, we will actually be directed to $DisplayMinutes$.

\subsubsection{A statechart and its correponding automaton}
\label{flattening}

It is possible to obtain an automaton from a statechart by flattening the statechart. The hierarchy and cocurrency need to be eliminated. In addition, statechart elements such as guard conditions and actions are not present in an automaton. 

The following examples were extracted from \cite{harel87:semantics_statecharts}. In figure~\ref{fig:stateFlat} we have a statechart and in figure~\ref{fig:flatStateNFA} its flat version that would correspond to an automaton.

\begin{figure}[htb]
\centering
\includegraphics[width=10cm]{figuras/statechartExample2}
\caption{\label{fig:stateFlat} A statechart model with hierarchy and concurrent regions}
\end{figure}

\begin{figure}[htb]
\centering
\includegraphics[width=10cm]{figuras/flatState}
\caption{\label{fig:flatStateNFA} The statechart from~\ref{fig:stateFlat} after flattening to the corresponding automaton}
\end{figure}

To flat a statechart and get the corresponding automaton, we need to pass transitions from the composed states to their substates to eliminiate hierarchy. To remove orthogonality, we need to do the cartesian product of the states in each concurrent region. Such operation will cause state and transition explosions in the automaton, if the original statechart model has many concurrent states. Besides, in the statechart we can use guard transitions and broadcasting, enriching the model with more information, but both features are absent in the automaton. Note that, in the automaton, the initial state is the product of the initial states from each parallel region in the statechart.

\iffalse
\begin{itemize}
\item Ortogonalidade

Um statechart pode estar em mais de um estado simultaneamente, o que é útil para modelar situações de concorrência e paralelismo. O conjunto de estados ativos em determinado instante é denominado de configuração. Na figura~\ref{fig:stateClock}, os estados $F$ e $G$ são ortogonais. Assim, se o statechart se encontrar no estado $A$ e o evento $a$ ocorrer, a configuração do statechart irá mudar para os estados $F$ e $G$ simultaneamente.
\item Hierarquia

Um estado pode conter sub-estados e transições internas, elevando a capacidade de abstração e encapsulamento. Na figura~\ref{fig:stateClock}, Os estados $F$ e $G$ são sub-estados do estado $I$. Já os estados $B$ e $C$ são sub-estados do estado $F$.
\item Condições de guarda

É possível condicionar a ocorrência de uma transição ao valor de uma variável, à entrada de um estado ou à ocorrência de uma ação. Na figura~\ref{fig:stateClock}, a transição do estado $D$ para o estado $E$ possui uma condição de guarda: $in(C)$, que é verdadeira quando o statechart se encontra no estado $C$ e falsa caso contrário. Então, a mudança de $D$ para $E$ acontecerá de fato se o evento $e$ ocorrer e a condição $in(C)$ for verdadeira, ou seja, quando $e$ ocorrer e a configuração atual do statechart contiver o estado $C$. 

\item Broadcasting

Uma transição possui um evento de entrada, necessário para que a transição aconteça, mas também pode ter uma ação de saída, que será disparada ao final da mudança de estado. Esse artefato permite que reações em cadeia ocorram em um statechart. Na figura~\ref{fig:stateClock}, a transição do estado $E$ para $D$ possui um evento de entrada $c$ e uma ação de saída $d$. Assim, suponha que os estados $C$ e $E$ constituam a atual configuração do statechart e o evento $c$ ocorra. A transição $E$ para $D$ ocorrerá e desencadeará a ação $d$, que por sua vez acarretará a transição de $C$ para $B$. No final, statechart estará com sua configuração nos estados $D$ e $B$, ainda que somente o evento $c$ tenha ocorrido. 
\item História

Um statechart é capaz de lembrar estados já visitados anteriormente. Na figura~\ref{fig:fig2}, o armazenamento da história do statechart é representado pelo pseudo-estado $H$. Se a configuração atual é $D$ e o evento $a$ ocorre, a próxima configuração será constituída pelo sub-estado de $A$ mais recentemente visitado: $B$ ou $C$. 
\end{itemize}

Um statechart também possui um estado inicial e pode possuir um estado final. Em casos de sistemas reativos, é comum que o estado final esteja ausente. O estado inicial é representado por um círculo completamente preenchido e o estado final, por um círculo preenchido contido em uma circunferência.

Um exemplo de figura está na figura~\ref{fig:stateClock}.
\begin{figure}[htb]
\includegraphics[width=10cm]{figuras/fig1}
\caption{\label{fig:stateClock}Exemplo de statechart}
\end{figure}

\begin{figure}[htb]
\includegraphics[width=12cm]{figuras/fig2}
\caption{\label{fig:fig2}Exemplo de statechart}
\end{figure}
\fi
